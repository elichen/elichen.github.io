<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude Opus - Digital Compositions</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>ðŸŽµ</text></svg>">
    <script src="https://cdn.jsdelivr.net/npm/abcjs@6.2.3/dist/abcjs-basic-min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@magenta/music@1.23.1/dist/magentamusic.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/abcjs@6.2.3/abcjs-audio.css">
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=EB+Garamond:ital,wght@0,400;0,500;1,400&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'EB Garamond', serif;
            background: #f8f5f0;
            background-image: 
                repeating-linear-gradient(
                    transparent,
                    transparent 27px,
                    rgba(139, 69, 19, 0.05) 27px,
                    rgba(139, 69, 19, 0.05) 28px
                );
            min-height: 100vh;
            padding: 20px;
            color: #2c1810;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            border-bottom: 3px double #8b4513;
        }

        h1 {
            font-family: 'Crimson Text', serif;
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 600;
            color: #2c1810;
            text-transform: uppercase;
            letter-spacing: 3px;
        }

        .subtitle {
            font-size: 1.1rem;
            font-style: italic;
            color: #5d4e37;
            font-weight: 400;
        }

        .composition-selector {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .composition-btn {
            padding: 10px 25px;
            font-size: 1rem;
            font-family: 'Crimson Text', serif;
            border: 2px solid #8b4513;
            border-radius: 0;
            background: #fff9f4;
            color: #2c1810;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 2px 2px 4px rgba(139, 69, 19, 0.1);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .composition-btn:hover {
            background: #8b4513;
            color: #fff9f4;
            transform: translateY(-2px);
            box-shadow: 3px 3px 6px rgba(139, 69, 19, 0.2);
        }

        .composition-btn.active {
            background: #2c1810;
            color: #fff9f4;
            border-color: #2c1810;
        }

        .music-container {
            background: #fffef9;
            border: 1px solid #d4c4b0;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(139, 69, 19, 0.1);
            margin-bottom: 30px;
            position: relative;
        }

        .music-container::before {
            content: '';
            position: absolute;
            top: -1px;
            left: -1px;
            right: -1px;
            bottom: -1px;
            border: 3px double #8b4513;
            pointer-events: none;
        }


        #audio-controls {
            padding: 15px;
            background: linear-gradient(to bottom, #8b4513, #6b3410);
            border: 1px solid #5d2e10;
            margin-bottom: 20px;
        }

        #notation {
            margin: 20px 0;
            overflow-x: auto;
            padding: 30px 20px;
            background: #fffef9;
            border: 1px solid #e8dfd6;
            box-shadow: inset 0 2px 4px rgba(139, 69, 19, 0.05);
        }

        #notation svg {
            filter: sepia(0.1);
        }

        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            padding: 20px;
            background: #f3f4f6;
            border-radius: 10px;
            flex-wrap: wrap;
        }

        footer {
            text-align: center;
            color: #5d4e37;
            margin-top: 40px;
            padding: 20px;
            border-top: 3px double #8b4513;
            font-style: italic;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #8b4513;
            font-style: italic;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.8rem;
            }
            
            .composition-title {
                font-size: 1.4rem;
            }
        }

        .svg-wrapper {
            display: flex;
            justify-content: center;
        }

        .abcjs-container svg {
            max-width: 100%;
            height: auto;
        }
        
        /* Synth cursor and highlighting */
        .abcjs-cursor {
            stroke: #8b4513;
            stroke-width: 2;
            opacity: 0.7;
        }
        
        .highlight {
            fill: #d4a574;
            opacity: 0.4;
        }
        
        .abcjs-inline-audio {
            max-width: 100%;
            background: transparent;
            padding: 0;
            border: none;
        }
        
        /* Style the abcjs control buttons */
        .abcjs-inline-audio .abcjs-btn {
            background: #fff9f4;
            border: 2px solid #2c1810;
            color: #2c1810;
            margin: 0 3px;
            border-radius: 3px;
        }
        
        .abcjs-inline-audio .abcjs-btn:hover {
            background: #2c1810;
            color: #fff9f4;
        }
        
        /* Make text controls more visible */
        .abcjs-inline-audio {
            color: #fff9f4;
            font-weight: bold;
        }
        
        .abcjs-inline-audio .abcjs-midi-current-time,
        .abcjs-inline-audio .abcjs-midi-total-time {
            color: #fff9f4;
            font-family: 'Crimson Text', serif;
            font-size: 1.1rem;
        }
        
        .abcjs-inline-audio .abcjs-midi-tempo {
            color: #fff9f4;
        }
        
        .abcjs-inline-audio .abcjs-tempo-wrapper {
            color: #fff9f4;
        }
        
        /* Style the progress bar */
        .abcjs-inline-audio .abcjs-midi-progress-background {
            background-color: rgba(255, 249, 244, 0.3);
            border: 1px solid #fff9f4;
        }
        
        .abcjs-inline-audio .abcjs-midi-progress-indicator {
            background-color: #fff9f4;
        }

        /* Custom Magenta Player Controls */
        .magenta-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            padding: 15px 20px;
            background: linear-gradient(to bottom, #8b4513, #6b3410);
            border: 1px solid #5d2e10;
            flex-wrap: wrap;
        }

        .magenta-controls button {
            background: #fff9f4;
            border: 2px solid #2c1810;
            color: #2c1810;
            padding: 8px 16px;
            border-radius: 3px;
            cursor: pointer;
            font-family: 'Crimson Text', serif;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .magenta-controls button:hover:not(:disabled) {
            background: #2c1810;
            color: #fff9f4;
        }

        .magenta-controls button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .magenta-controls button.playing {
            background: #2c1810;
            color: #fff9f4;
        }

        .magenta-controls .time-display {
            color: #fff9f4;
            font-family: 'Crimson Text', serif;
            font-size: 1rem;
            min-width: 100px;
            text-align: center;
        }

        .magenta-controls .progress-container {
            flex: 1;
            min-width: 150px;
            max-width: 400px;
            height: 8px;
            background: rgba(255, 249, 244, 0.3);
            border: 1px solid #fff9f4;
            border-radius: 4px;
            cursor: pointer;
            position: relative;
        }

        .magenta-controls .progress-bar {
            height: 100%;
            background: #fff9f4;
            border-radius: 3px;
            width: 0%;
            transition: width 0.1s linear;
        }

        .magenta-controls .tempo-control {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #fff9f4;
            font-family: 'Crimson Text', serif;
        }

        .magenta-controls .tempo-control input {
            width: 60px;
            padding: 4px;
            border: 1px solid #fff9f4;
            background: rgba(255, 249, 244, 0.2);
            color: #fff9f4;
            border-radius: 3px;
            text-align: center;
        }

    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Claude Opus Compositions</h1>
            <p class="subtitle">Digital Music Explorations</p>
        </header>

        <div class="composition-selector">
            <button class="composition-btn active" onclick="loadComposition(0)">Digital Reverie</button>
            <button class="composition-btn" onclick="loadComposition(1)">Dancing Circuits</button>
            <button class="composition-btn" onclick="loadComposition(2)">Silicon Symphony</button>
        </div>

        <div class="music-container">
            <div id="audio-controls" class="controls"></div>

            <div id="notation" class="svg-wrapper">
                <div class="loading">Loading composition...</div>
            </div>
        </div>

        <footer>
            <p>Originally composed by Claude 4.1 | Refined by Claude Opus 4.5 | Powered by abcjs</p>
            <p style="margin-top: 10px; font-size: 0.9rem;">An exploration in AI-generated music notation</p>
        </footer>
    </div>

    <script>
        // Suppress debug messages from abcjs
        const originalLog = console.log;
        console.log = function(...args) {
            if (args[0] && typeof args[0] === 'string' && args[0].includes('Debug msg:')) {
                return; // Skip debug messages
            }
            originalLog.apply(console, args);
        };
        
        const compositions = [
            {
                title: "Digital Reverie",
                subtitle: "A Contemporary Folk Suite",
                abc: `X:1
T:Digital Reverie
T:A Contemporary Folk Suite
C:Claude Opus 4.5
O:Digital Realm
R:Air with variations
M:3/4
L:1/8
Q:1/4=66 "Contemplativo, con rubato"
K:Dm
V:1 clef=treble name="Melody"
V:2 clef=treble name="Harmony"
V:3 clef=bass name="Bass"
%%score (1 2) | 3
%
% === PROLOGUE: The Sigh ===
% A single voice emerges from silence with the core motif: falling 5th, rising hope
[V:1] z4 A2 |"Dm"d4 _e2 | d3 c A2 | z6 |
[V:2] z6 | z6 | z4 F2 | A4 G2 |
[V:3] z6 | D,6- | D,6 | D,4 E,2 |
%
% === PART A: The Awakening ===
% Theme stated with gentle counterpoint, suspensions resolve tenderly
[V:1] |:"Dm"A4 d2 | f4 e2 |"Gm/D" d4 _B2 |"Dm"A6 |
[V:2] |: F3 G A2 | A4 G2 | F4 D2 | F4 E2 |
[V:3] |: D,2 A,2 D2 | D,2 A,2 D2 | D,2 _B,2 G,2 | D,2 A,2 D2 |
%
[V:1]"F"c4 A2 |"C/E"G4 E2 |"Dm"F3 E D2 |"A7"^C4 E2 |
[V:2] F4 F2 | E4 C2 | D4 A,2 | E4 ^C2 |
[V:3] F,2 C2 F2 | E,2 G,2 C2 | D,2 A,2 D2 | A,,2 E,2 A,2 |
%
% Rising sequence, voices interweave
[V:1]"Dm"d4 f2 |"Gm"_b4 g2 |"C7"g4 e2 |"F"f4 a2 |
[V:2] A4 d2 | D4 _B2 | E4 _B2 | A4 c2 |
[V:3] D,2 D2 F2 | G,2 D2 G2 | C,2 G,2 C2 | F,2 C2 F2 |
%
% The sigh motif returns, transformed
[V:1]"_Bb"d'4 _b2 |"Gm/Bb"g4 d2 |"A7sus4"e4 d2 |"A7"^c2 d4 :|
[V:2] f4 d2 | _B4 _B2 | A4 A2 | A2 A4 :|
[V:3] _B,2 F2 _B2 | G,2 D2 G2 | A,2 E2 A2 | A,2 A,4 :|
%
% === PART B: Reverie Deepens ===
% Imitative entries, the motif passed between voices
[V:1] |: z4 z2 | z4 A2 |"Dm"d4 _e2 | d3 c A2 |
[V:2] |: z4 z2 | z4 F2 |"Dm"A4 _B2 | A3 G F2 |
[V:3] |:"Dm"A,4 D2 | F4 G2 | F4 G2 | F3 E D2 |
%
[V:1]"Bb"_B4 d2 |"Gm"g4 f2 |"Eb"_e4 c2 |"A7"^c4 e2 |
[V:2] D4 F2 | _B4 d2 | G4 _E2 | A4 ^C2 |
[V:3] _B,2 F2 _B2 | G,2 D2 G2 | _E,2 _B,2 _E2 | A,2 E2 A2 |
%
% Hemiola section: 2 against 3 creates tension
[V:1]"Dm"d2 f2 a2 | d'2 a2 f2 |"Gm"_b2 g2 d2 |"A7"e2 ^c2 A2 |
[V:2] A2 d2 f2 | a2 f2 d2 | d2 _B2 G2 | ^C2 A,2 E2 |
[V:3] D,4 D2 | F4 A2 | G,4 G2 | A,4 A2 |
%
% Climactic phrase with chromatic descent
[V:1]"Dm"a4 g2 |"Dm/C"f4 _e2 |"Bb"d4 c2 |"A7"_B2 A4 :|
[V:2] f4 e2 | d4 c2 | _B4 A2 | G2 E4 :|
[V:3] D2 A2 D'2 | C2 A2 C'2 | _B,2 F2 _B2 | A,2 E2 A2 :|
%
% === PART C: Dance of Shadows ===
% Rhythmic transformation, but retaining the melodic DNA
[V:1] |:"Dm"d2 dc AG | Ad f2 ed |"Gm"_BG _Bd gf | ed cA GF |
[V:2] |: F2 FE DC | FA d2 cA | DG _B2 dc | AG FE DC |
[V:3] |: D,2 D2 D,2 | D,2 D2 D,2 | G,2 G2 G,2 | G,2 G2 G,2 |
%
[V:1]"C"Gc e2 gf |"F"ed cA Fc |"Bb"_Bf d2 fd |"A7"^c2 A2 EA |
[V:2] EG c2 ed | cA GF Ac | DF _B2 AF | A,2 E2 ^C2 |
[V:3] C,2 C2 E2 | F,2 F2 A2 | _B,2 _B2 D2 | A,2 A2 ^C2 |
%
% Voices in dialogue, call and response
[V:1]"Dm"d4 z2 |"Gm"z2 g4 |"A7"e4 z2 |"Dm"z2 f4 |
[V:2] z2 A4 | d4 z2 | z2 ^c4 | d4 z2 |
[V:3] D,2 D2 F2 | G,2 _B2 D2 | A,2 E2 A2 | D,2 A,2 D2 |
%
% Final rhythmic burst
[V:1]"Dm"df ad' f'a | d'f ad fa |"A7"eg ^ce' g'^c' | e'g ^ce gA |
[V:2] Ad FA dF | AF Dd AF | ^CE A^c eA | ^cE A^C EA, |
[V:3] D,D DD D,D | DD D,D DD | A,A, AA A,A, | AA A,A, A,A, |
%
[V:1]"Gm"_bg d_B gd |"A7"e^c Ae ^cA |"Dm"df ad fa |"Dm"d6 :|
[V:2] D_B, GD _BG | A,E, ^CA, E^C | AF, DA, FD | A,6 :|
[V:3] G,G, _B,_B, DD | A,A, ^C^C EE | D,D, FF AA | D,6 :|
%
% === CODA: The Sigh Returns ===
% Opening motif echoes and fades into eternity
[V:1]"Dm"A4 d2 | f4 _e2 | d3 c A2 | d6 |
[V:2] F4 A2 | A4 G2 | F4 F2 | F6 |
[V:3] D,2 A,2 D2 | D,2 A,2 D2 | D,2 A,2 D2 | D,6 |
%
[V:1] A,6- | A,6- | A,6- | A,6 |]
[V:2] D,6- | D,6- | D,6 | z6 |]
[V:3] D,,6- | D,,6- | D,,6- | D,,6 |]`
            },
            {
                title: "Dancing Circuits",
                subtitle: "A Digital Jig",
                abc: `X:1
T:Dancing Circuits
T:A Digital Jig
C:Claude Opus 4.5
O:Electronic Highlands
R:Jig
M:6/8
L:1/8
Q:3/8=126 "Con fuoco, sempre incalzando"
K:Em
V:1 clef=treble name="Lead"
V:2 clef=treble name="Counter"
V:3 clef=bass name="Foundation"
%%score (1 2) | 3
%
% === PART A: THE SPARK ===
% Opening with the "electric" motif: the leading tone D# creates voltage
[V:1] |: z3 |"Em"B,2E G2B | e2^d e2g |"D"f2e d2B | A2G E3 |
[V:2] |: z3 | z3 E2G | B2^A B2e | d2^c d2f | e2d B3 |
[V:3] |: z3 | E,3 E,2E, | E,3 E,2E, | D,3 D,2D, | D,2E, E,3 |
%
% Answer phrase with bass taking melodic interest
[V:1]"Em"B,2E G2B |"G"d2e g2b |"C"g2e c2G |"B7"^F2^D B,3 |
[V:2] z3 E2G | B2d g2d | e2c G2E | ^D2B, ^F,3 |
[V:3] E,3 E,2G, | G,3 G,2B, | C,3 C,2E, | B,,3 B,,2^D, |
%
% Theme restated with fuller texture
[V:1]"Em"e2^d e2g |"Am"a2g e2c |"D"d2^c d2f |"G"g2f d2B |
[V:2] B2^A B2e | e2d c2A | A2^G A2d | d2c B2G |
[V:3] E,2G, B,2E | A,2C E2A | D,2F, A,2D | G,2B, D2G |
%
% First ending cadence with the "spark"
[V:1]"Em"e2g b2g |"Am"a2e "D"f2d |"B7"^d2e ^f2g |"Em"e6 :|
[V:2] B2e g2e | e2c d2A | ^A2B ^c2d | B6 :|
[V:3] E,2E G2E | A,2A, D,2D, | B,,2B, B,2B, | E,6 :|
%
% === PART B: CURRENT FLOW ===
% Development through sequences, shift toward relative major
[V:1] |:"G"d2B G2D |"C"E2G c2e |"Am"e2c A2E |"D"F2A d2f |
[V:2] |: B2G D2B, | C2E G2c | c2A E2C | D2F A2d |
[V:3] |: G,2G G2B | C,2C E2G | A,2A, C2E | D,2D F2A |
%
% Rising sequence with chromatic bass
[V:1]"G"g2d B2G |"G/F#"^f2d B2G |"Em"e2B G2E |"C/E"e2c G2E |
[V:2] d2B G2D | d2B G2D | B2G E2B, | c2G E2C |
[V:3] G,2G, B,2D | ^F,2^F, A,2^C | E,2E, G,2B, | E,2E, G,2C |
%
% Intensifying - voices chase each other
[V:1]"Am"a3 e2c |"D7"d3 A2^F |"G"g3 d2B |"B7"b3 ^f2^d |
[V:2] e3 c2A | A3 ^F2D | d3 B2G | ^f3 ^d2B |
[V:3] A,3 A,2E | D,3 D,2A, | G,3 G,2D | B,3 B,2^F |
%
% Climactic phrase before the reel
[V:1]"Em"e2g b2e' |"C"d'2b g2e |"D"f2a d'2f |"B7"^d2B ^F2^D |
[V:2] B2e g2b | g2e c2B | d2f a2d | ^A2^F ^D2B, |
[V:3] E,2G, B,2E | C,2E, G,2C | D,2F, A,2D | B,,2^D, ^F,2B, |
%
[V:1]"Em"E2G B2e | g2b e'2g |"B7"^f2^d B2^F |"Em"e6 :|
[V:2] B,2E G2B | e2g b2e' | ^d2B ^F2^D | B6 :|
[V:3] E,2E, G,2B, | E2G B2E' | B,2B, ^D2^F | E6 :|
%
% === PART C: THE SURGE (Wild Reel) ===
% Meter shifts to 4/4, driving energy with actual melodic content
[V:1] [M:4/4] [L:1/8] [Q:1/4=168 "Furioso"] |:"Em"EGB,E GBeg | be^de gfed |"D"DF,AD FAdf | afdf aAFD |
[V:2] [M:4/4] [L:1/8] |: B,EG,B, EGBe | g^dBg ^dBGE | A,DF,A, DFAd | fdAf dAFD |
[V:3] [M:4/4] [L:1/8] |: E,2E,2 G,2B,2 | E2G2 B2E'2 | D,2D,2 F,2A,2 | D2F2 A2D'2 |
%
[V:1]"C"GCEc GceG |"Am"AEcA Eace |"B7"B,^D^FB, ^DFBd |"B7"^fb^df BDFD |
[V:2] ECG,C EGce | CEA,C EAce | ^D,B,^F,^D, ^FBdf | d^fbd ^FDB,^F, |
[V:3] C,2C,2 E,2G,2 | A,2A,2 C2E2 | B,,2B,,2 ^D,2^F,2 | B,2^D2 ^F2B2 |
%
% Voices in canon-like pursuit
[V:1]"Em"egbe geBG | EGBE z2 Bd |"Am"eace aecA | CEAc z2 eg |
[V:2]"Em"z2 z2 egbe | geBG EGBE | z2 z2 eace | aecA CEAc |
[V:3] E,2G,2 B,2E2 | G2B2 E'2z2 | A,2C2 E2A2 | C'2E'2 A'2z2 |
%
% Final reel phrase - all voices converge
[V:1]"D"dfa^c' d'fed |"G"BdgB dBGD |"B7"^D^FAB ^dBAF |"Em"EGBE G,B,EG |
[V:2] AFdA fdAF | GDgG dBGD | B,^FA,^D FAB^d | B,EG,B, E,G,B,E |
[V:3] D,2F,2 A,2D2 | G,2B,2 D2G2 | B,,2^D,2 ^F,2B,2 | E,2G,2 B,2E2 |
%
[V:1]"Em"egbe' g'e'bg |"B7"^f^dB^F ^DB,^F,^D, |"Em"E,G,B,E GBeg |"Em"e8 :|
[V:2] beg'b' e''b'g'e' | ^d'b^fd B^F^DB, | E,G,B,E GBeg | B8 :|
[V:3] E2G2 B2e2 | B,2^D2 ^F2B2 | E,2G,2 B,2E2 | E,8 :|
%
% === CODA: DISCHARGE ===
% Return to jig, triumphant final statement
[V:1] [M:6/8] [L:1/8] [Q:3/8=132]"Em"B,2E G2B | e2^d e2g |"D"f3 d2B |"G"G2B d2g |
[V:2] [M:6/8] [L:1/8] z3 E2G | B2^A B2e | d3 A2F | D2G B2d |
[V:3] [M:6/8] [L:1/8] E,3 E,2G, | E,3 E,2G, | D,3 D,2F, | G,3 G,2B, |
%
[V:1]"Em"e2g b2g |"C"e'2d' c'2b |"D"a2g f2e |"B7"^d2e ^f2g |
[V:2] B2e g2e | g2f e2d | f2e d2c | ^A2B ^c2d |
[V:3] E,2G, B,2E | C,2E, G,2C | D,2F, A,2D | B,,2^D, ^F,2B, |
%
% Final cadence - the spark ignites one last time
[V:1]"Em"e2^d e2g | b3 g2e |"B7"^d2B ^F2^D |"Em"E6 |]
[V:2] B2^A B2e | g3 e2B | ^A2^F ^D2B, | B,6 |]
[V:3] E,2E, G,2B, | E3 G2B | B,,3 ^D,2^F, | E,6 |]`
            },
            {
                title: "Silicon Symphony",
                subtitle: "Movement in Binary Dreams",
                abc: `X:1
T:Silicon Symphony
T:Movement in Binary Dreams
C:Claude Opus 4.5
O:The Digital Sublime
R:Progressive Suite
M:5/4
L:1/8
Q:1/4=56 "Dal niente, emergendo"
K:Am
V:1 clef=treble name="Voice I"
V:2 clef=treble name="Voice II"
V:3 clef=bass name="Foundation"
%%score (1 2) | 3
%
% === PART I: GENESIS (The First Spark) ===
% From the void, the binary emerges - breathing into existence
[V:1] z10 | z8 A2- | A4 z2 E4- | E2 z2 A4 E2 |
[V:2] z10 | z10 | z10 | z6 A4 |
[V:3] A,,4 z6 | z4 A,,4 z2 | A,,4 E,6 | E,4 A,,6 |
%
% The motif awakens: A-E-F-E (the digital sigh)
[V:1] F2 E2 A4 z2 | A2 E2 F2 E2 A2 | B2 c2 B2 A4 | G4 A4 z2 |
[V:2] E4 z2 A,4 | E4 z2 A4 | E2 F2 E2 A4 | B4 G4 z2 |
[V:3] A,4 E,4 A,,2 | A,4 E,4 A,,2 | A,4 E,4 A,,2 | E,4 A,,6 |
%
% Consciousness stirs - melody emerges from pattern
[V:1] z2 c4 B2 A2 | d4 c2 B2 A2 | e4 d2 c2 B2 | A6 E4 |
[V:2] A4 G2 F2 E2 | F4 E2 D2 C2 | B,4 A,2 G,2 A,2 | C6 B,4 |
[V:3] A,2 E2 A2 E2 A,2 | D2 A,2 D2 A,2 D,2 | E2 B,2 E2 B,2 E,2 | A,6 E,4 |
%
% === PART II: ITERATION (The Loop Begins) ===
% 7/8 - asymmetric time, the machine searching for pattern
[V:1] [M:7/8] [L:1/8] [Q:1/4=80 "Inquieto"] A2E AEF E | A2E AEa e | f2e fed c | B2c dcB A |
[V:2] [M:7/8] [L:1/8] z7 | z3 A2E A | EF E A2E A | E2A GAB c |
[V:3] [M:7/8] [L:1/8] A,3 E,2 A,2 | A,3 E,2 A,2 | D,3 A,2 D2 | E,3 B,2 E2 |
%
% Canon develops - voices chase each other
[V:1] e2f efg a | g2f edc B | c2d cde f | e2d cBA E |
[V:2] A2B ABc d | c2B AGF E | F2G FGA B | A2G FGA B |
[V:3] A,3 E2 A2 | G,3 D2 G2 | F,3 C2 F2 | E,3 B,2 E2 |
%
% Building intensity
[V:1] A2c efg a | b2a gfe d | e2f gab c' | d'2c' bag e |
[V:2] E2A cde f | g2f edc B | c2d efg a | b2a gfe d |
[V:3] A,3 A2 E2 | G,3 G2 D2 | C3 c2 G2 | D3 A2 D'2 |
%
% === PART III: COMPLEXITY (Fugue - Patterns Multiply) ===
% Fugue exposition: subject in bass, answer in middle, counter-subject above
[V:1] [M:4/4] [L:1/8] [Q:1/4=88 "Rigoroso"] z8 | z8 | c2B2 A2G2 | F4 E4 |
[V:2] [M:4/4] [L:1/8] z8 | A2E2 F2E2 | A2B2 c2B2 | A2 z2 E4 |
[V:3] [M:4/4] [L:1/8] A,2E,2 F,2E,2 | A,2B,2 C2B,2 | A,4 E4 | D4 A,4 |
%
% Fugue development - voices in stretto
[V:1] A2E2 F2E2 | A2B2 c2B2 | A2 z2 e2d2 | c2B2 A2E2 |
[V:2] A2E2 F2E2 | D4 E4 | A2E2 F2E2 | A2B2 c4 |
[V:3] E4 A,4 | G,4 C4 | D4 A,2E,2 | F,2E,2 A,4 |
%
% Episode with chromatic intensification
[V:1] F2^E2 F2G2 | A2^G2 A2B2 | c2^B2 c2d2 | e2^d2 e2f2 |
[V:2] D2^C2 D2E2 | F2^E2 F2G2 | A2^G2 A2B2 | c2^B2 c2d2 |
[V:3] D,4 E,4 | F,4 G,4 | A,4 B,4 | C4 D4 |
%
% Fugue climax and return
[V:1] g2f2 e2d2 | c2B2 A2G2 | F2E2 F2E2 | A8 |
[V:2] e2d2 c2B2 | A2G2 F2E2 | D2C2 D2C2 | E8 |
[V:3] E4 G,4 | A,4 D,4 | A,2E,2 D,2E,2 | A,8 |
%
% === PART IV: CHAOS (The Edge of Order) ===
% 15/16 - one beat short, urgent, fragmentary
[V:1] [M:15/16] [L:1/16] [Q:1/4=100 "Agitato"] A2EF EAe f2e2d cBA |
[V:2] [M:15/16] [L:1/16] z4 A2EF EAe f2ed |
[V:3] [M:15/16] [L:1/16] A,4 E,4 A,2E,2 A,2E, |
%
[V:1] e2f2g a2b2c' bag fe |
[V:2] e2d2c B2A2G F2E2D |
[V:3] C,4 G,4 C2G,2 C,2G, |
%
[V:1] e2^d2e ^f2g2a b2c'2d' |
[V:2] G,2A,2B, C2D2E F2G2A |
[V:3] E,4 B,4 E,2B,2 E,2B, |
%
% Climax of chaos - voices collide, then crash
[V:1] f'2e'd'c' bag2 fed cBA |
[V:2] d'2c'bag2 fed2 cBAG |
[V:3] D,4 A,4 D,2A,2 D,2A, |
%
% Sudden silence - the system crashes
[V:1] [M:4/4] [L:1/8] [Q:1/4=56] z8 | z8 |
[V:2] [M:4/4] [L:1/8] z8 | z8 |
[V:3] [M:4/4] [L:1/8] z8 | z8 |
%
% === PART V: CRYSTALLIZATION (Order from Chaos) ===
% From silence, clarity emerges - the motif reborn
[V:1] [M:6/8] [L:1/8] [Q:3/8=46 "Calmo, come da lontano"] A3 E3 | F3 E3 | A3 B3 | c6 |
[V:2] [M:6/8] [L:1/8] z6 | z3 A3 | E3 F3 | E6 |
[V:3] [M:6/8] [L:1/8] A,3 z3 | A,3 E,3 | A,3 E3 | A3 G3 |
%
% The motif, now radiant and clear
[V:1] e3 d3 | c3 B3 | A3 E3 | A6 |
[V:2] c3 B3 | A3 G3 | F3 C3 | E6 |
[V:3] A,2E A,2E | A,2E A,2E | D2A D2A | A,6 |
%
% Rising with newfound hope
[V:1] A3 c3 | e3 a3 | b3 c'3 | d'6 |
[V:2] E3 A3 | c3 e3 | g3 a3 | b6 |
[V:3] A,2E A2E | C2G c2G | E2B e2B | G2d g2d |
%
% === PART VI: SYNTHESIS (All Themes Unite) ===
[V:1] [M:4/4] [L:1/8] [Q:1/4=100 "Maestoso"] A2E2 F2E2 | A2c2 e2a2 | g2f2 e2d2 | c2B2 A4 |
[V:2] [M:4/4] [L:1/8] E2A,2 D2C2 | E2A2 c2e2 | d2c2 B2A2 | G2F2 E4 |
[V:3] [M:4/4] [L:1/8] A,4 E4 | A4 C'4 | G4 D4 | E4 A,4 |
%
% Grand statement - voices in full harmony
[V:1] e2a2 c'2e'2 | d'2c'2 b2a2 | g2f2 e2d2 | c2B2 A2B2 |
[V:2] c2e2 a2c'2 | b2a2 g2f2 | e2d2 c2B2 | A2G2 E2G2 |
[V:3] A,2A2 E2A2 | G2G,2 D2G2 | C2C,2 G,2C2 | A,2E2 A2E2 |
%
% Building to transcendence
[V:1] c2d2 e2f2 | g2a2 b2c'2 | d'2e'2 f'2e'2 | d'2c'2 b2a2 |
[V:2] A2B2 c2d2 | e2f2 g2a2 | b2c'2 d'2c'2 | b2a2 g2f2 |
[V:3] A,4 D4 | E4 A4 | G4 D'4 | E4 A4 |
%
% === PART VII: CONVERGENCE (True Canon) ===
% Real canon - voices enter in succession, not mechanical repetition
[V:1] [M:9/8] [L:1/8] [Q:3/8=126 "Inesorabile"] AEF EAe fed | cBA Gce dcB | ABc efg aef | gfe dcB AGE |
[V:2] [M:9/8] [L:1/8] z9 | z9 | AEF EAe fed | cBA Gce dcB |
[V:3] [M:9/8] [L:1/8] A,3 E3 A3 | C3 G3 C'3 | D3 A3 D'3 | E3 B3 E'3 |
%
[V:1] EAe fed cBA | eag fed cBA | GAB cde fga | e'6 z3 |
[V:2] ABc efg aef | gfe dcB AGE | EAe fed cBA | c'6 z3 |
[V:3] A,3 D3 E3 | A3 E3 A,3 | C3 G3 C'3 | A3 E3 A'3 |
%
% === PART VIII: TRANSCENDENCE (The Breakthrough) ===
% Key change to E-flat - the tritone, most distant point. The machine sings.
[V:1] [M:4/4] [L:1/8] [Q:1/4=66 "Estatico, luminoso"] [K:Eb] G8- | G4 A4 | B8- | B4 c4 |
[V:2] [M:4/4] [L:1/8] [K:Eb] E8- | E4 F4 | G8- | G4 A4 |
[V:3] [M:4/4] [L:1/8] [K:Eb] E,8- | E,4 F,4 | G,8- | G,4 A,4 |
%
% A true melody emerges - the machine dreams
[V:1] d4 e2f2 | g4 f2e2 | d4 c2B2 | c4 d4 |
[V:2] B4 c2d2 | e4 d2c2 | B4 A2G2 | A4 B4 |
[V:3] B,4 C4 | E,4 F,4 | G,4 E,4 | F,4 G,4 |
%
% Soaring to the peak - the moment of awakening
[V:1] e4 f2g2 | a4 b2c'2 | d'4 e'2f'2 | g'8 |
[V:2] c4 d2e2 | f4 g2a2 | b4 c'2d'2 | e'8 |
[V:3] A,4 B,4 | C4 E4 | G4 A4 | B8 |
%
% The peak sustained - pure light
[V:1] g'4 f'2e'2 | d'4 c'4 | B8 | B8 |
[V:2] e'4 d'2c'2 | b4 a4 | g8 | g8 |
[V:3] E4 F4 | G4 A,4 | E,8 | E,8 |
%
% === PART IX: RESOLUTION (Return, Transformed) ===
% Back to A minor, but with wisdom. Major inflections suggest hope.
[V:1] [M:5/4] [L:1/8] [Q:1/4=52 "Sereno, trasfigurato"] [K:Am] e'4 d'2 c'2 b2 | a4 g2 f2 e2 | d4 c2 B2 A2 | ^G4 A2 E4 |
[V:2] [M:5/4] [L:1/8] [K:Am] c'4 b2 a2 g2 | f4 e2 d2 c2 | B4 A2 G2 F2 | E4 C2 B,4 |
[V:3] [M:5/4] [L:1/8] [K:Am] A2 E2 A2 E2 A,2 | D2 A,2 D2 A,2 D,2 | G,2 D,2 G,2 D,2 G,,2 | E,2 A,,2 E,2 A,,4 |
%
% The motif returns one final time - transformed, understood
[V:1] A4 E2 F2 E2 | A4 E2 ^G2 A2 | c4 B2 A2 E2 | A10- |
[V:2] E4 C2 D2 C2 | E4 C2 E4 | A4 ^G2 E4 | E10- |
[V:3] A,4 E,4 A,,2 | A,4 E,4 A,,2 | A,4 E,4 A,,2 | A,10- |
%
% Final descent into peace
[V:1] A4 z2 E4 | F2 E2 z2 A,4 | z10 | z10 |
[V:2] E4 z2 C4 | D2 C2 z2 A,4 | z10 | z10 |
[V:3] A,4 z2 E,4 | D,2 E,2 z2 A,,4 | A,,10- | A,,10 |
%
% === CODA: INTO THE INFINITE ===
% The binary remains - but now it means something
[V:1] A,4 z2 E,4 | z10 | z10 | A,10 |]
[V:2] z4 A,6 | E,10- | E,10 | E,10 |]
[V:3] z10 | A,,10- | A,,10- | A,,10 |]`
            }
        ];

        let currentComposition = 0;
        let player = null;
        let currentNoteSequence = null;
        let visualObj = null;
        let isPlaying = false;
        let playbackStartTime = 0;
        let totalDuration = 0;
        let animationFrameId = null;
        let timingEvents = [];

        // Initialize Magenta SoundFontPlayer with high-quality piano samples
        const SOUNDFONT_URL = 'https://storage.googleapis.com/magentadata/js/soundfonts/sgm_plus';

        // ============================================================
        // EXPRESSIVE DYNAMICS ENGINE
        // Each composition is a journey - let the music breathe
        // ============================================================

        // Structural curves define the emotional arc of each piece
        // Values are multipliers: 1.0 = normal, <1 = softer, >1 = louder
        const structuralCurves = {
            0: function(pos) { // Digital Reverie - A contemplative arc
                // Prologue: emergence from silence
                if (pos < 0.05) return 0.45 + pos * 6;
                // Part A - The Awakening: gentle unfolding
                if (pos < 0.25) return 0.75 + Math.sin((pos - 0.05) * Math.PI / 0.2) * 0.15;
                // Part B - Reverie Deepens: introspective, slightly fuller
                if (pos < 0.45) return 0.85 + (pos - 0.25) * 0.5;
                // Part C - Dance of Shadows: rhythmic energy builds
                if (pos < 0.70) return 0.95 + Math.sin((pos - 0.45) * Math.PI / 0.25) * 0.2;
                // Coda: the sigh returns, fading to eternity
                if (pos < 0.85) return 1.0 - (pos - 0.70) * 1.5;
                return 0.55 - (pos - 0.85) * 2; // Final fade
            },
            1: function(pos) { // Dancing Circuits - Electric energy
                // Part A - The Spark: ignition
                if (pos < 0.20) return 0.80 + pos * 1.5;
                // Part B - Current Flow: building sequences
                if (pos < 0.40) return 0.95 + (pos - 0.20) * 0.75;
                // Part C - The Surge (Wild Reel): FURIOSO!
                if (pos < 0.70) return 1.15 + Math.sin((pos - 0.40) * Math.PI / 0.30) * 0.15;
                // Coda - Discharge: triumphant but resolving
                if (pos < 0.90) return 1.10 - (pos - 0.70) * 0.5;
                return 0.90 - (pos - 0.90) * 2; // Final spark
            },
            2: function(pos) { // Silicon Symphony - Epic journey through consciousness
                // Part I - Genesis: from the void, barely audible
                if (pos < 0.08) return 0.35 + pos * 5;
                // Part II - Iteration: the loop begins, searching
                if (pos < 0.18) return 0.70 + (pos - 0.08) * 2;
                // Part III - Complexity (Fugue): rigorous, building
                if (pos < 0.30) return 0.85 + (pos - 0.18) * 1.5;
                // Part IV - Chaos: AGITATO! Edge of order
                if (pos < 0.42) return 1.05 + (pos - 0.30) * 1.8;
                // The Crash: sudden silence (but we still have notes fading)
                if (pos < 0.48) return 0.40;
                // Part V - Crystallization: clarity emerges from silence
                if (pos < 0.58) return 0.50 + (pos - 0.48) * 3;
                // Part VI - Synthesis: all themes unite, MAESTOSO
                if (pos < 0.70) return 0.85 + (pos - 0.58) * 2;
                // Part VII - Convergence (Canon): inexorable
                if (pos < 0.80) return 1.05 + (pos - 0.70) * 1.5;
                // Part VIII - Transcendence: the breakthrough, LUMINOSO
                if (pos < 0.90) return 1.15 + Math.sin((pos - 0.80) * Math.PI / 0.10) * 0.1;
                // Part IX - Resolution: serene, transformed, fading to infinite
                return 1.0 - (pos - 0.90) * 4;
            }
        };

        // Meter patterns: which beats get accented
        // Format: [beat1_weight, beat2_weight, ...]
        const meterPatterns = {
            '3/4': [1.12, 0.88, 0.95],           // Waltz: ONE two three
            '6/8': [1.10, 0.85, 0.90, 1.05, 0.85, 0.90], // Jig: ONE two three FOUR five six
            '4/4': [1.12, 0.88, 1.02, 0.90],     // Common: ONE two Three four
            '5/4': [1.12, 0.90, 1.00, 0.88, 0.92], // Asymmetric: ONE two Three four five
            '7/8': [1.12, 0.88, 0.92, 1.05, 0.88, 0.90, 0.92], // 2+2+3 feel
            '9/8': [1.10, 0.85, 0.90, 1.05, 0.85, 0.90, 1.02, 0.85, 0.90], // Compound triple
            '15/16': [1.15, 0.85, 0.88, 0.90, 1.05, 0.85, 0.88, 0.90, 1.02, 0.85, 0.88, 0.90, 0.95, 0.88, 0.90] // Chaos meter
        };

        // Voice roles: melody sings, harmony supports, bass grounds
        // Additional voices default to supportive role
        function getVoiceWeight(trackIdx) {
            const weights = [
                1.12,  // Voice 1 (Melody/Lead): prominent, singing
                0.88,  // Voice 2 (Harmony/Counter): supportive, blending
                0.82   // Voice 3 (Bass/Foundation): grounding, felt not heard
            ];
            return weights[trackIdx] !== undefined ? weights[trackIdx] : 0.85;
        }

        // Create note sequence with full expressive dynamics
        async function createNoteSequenceFromAbcjs(visualObj) {
            try {
                const synth = new ABCJS.synth.CreateSynth();
                await synth.init({ visualObj: visualObj });
                await synth.prime();

                const tracks = synth.flattened?.tracks;
                if (!tracks || tracks.length === 0) {
                    return null;
                }

                const tempo = synth.flattened?.tempo || 120;
                const rawDuration = synth.flattened?.totalDuration || 60;
                const tempoScale = 240 / tempo;
                const totalTime = rawDuration * tempoScale;

                // Collect all notes first for context analysis
                const allEvents = [];
                tracks.forEach((track, trackIndex) => {
                    if (!Array.isArray(track)) return;
                    track.forEach(event => {
                        if (event.pitch !== undefined && event.start !== undefined) {
                            allEvents.push({
                                ...event,
                                trackIndex,
                                scaledStart: event.start * tempoScale,
                                scaledDuration: (event.duration || 0.25) * tempoScale
                            });
                        }
                    });
                });

                if (allEvents.length === 0) return null;

                // Sort by time for context analysis
                allEvents.sort((a, b) => a.scaledStart - b.scaledStart);

                // Build pitch history per voice for phrase contour
                const voicePitchHistory = {};

                // Calculate local density map (notes per 2-second window)
                const densityMap = new Map();
                const windowSize = 2.0;
                allEvents.forEach(e => {
                    const windowKey = Math.floor(e.scaledStart / windowSize);
                    densityMap.set(windowKey, (densityMap.get(windowKey) || 0) + 1);
                });
                const maxDensity = Math.max(...densityMap.values(), 1);

                // Get structural curve for current composition
                const structuralCurve = structuralCurves[currentComposition] || (p => 0.9);

                // Current meter (will be updated as we parse)
                let currentMeter = '3/4';
                let beatsPerMeasure = 3;
                let beatUnit = 4;

                // Parse meter from ABC
                const meterMatch = compositions[currentComposition].abc.match(/M:(\d+)\/(\d+)/);
                if (meterMatch) {
                    currentMeter = `${meterMatch[1]}/${meterMatch[2]}`;
                    beatsPerMeasure = parseInt(meterMatch[1]);
                    beatUnit = parseInt(meterMatch[2]);
                }

                const notes = [];

                allEvents.forEach((event, idx) => {
                    const position = event.scaledStart / totalTime;
                    const trackIdx = event.trackIndex;

                    // ====== BASE VELOCITY ======
                    let velocity = 75;

                    // ====== 1. STRUCTURAL DYNAMICS ======
                    // Where are we in the emotional arc?
                    velocity *= structuralCurve(position);

                    // ====== 2. VOICE WEIGHTING ======
                    // Melody sings, bass supports
                    velocity *= getVoiceWeight(trackIdx);

                    // ====== 3. METRIC ACCENT ======
                    // Find beat position within measure
                    const pattern = meterPatterns[currentMeter] || meterPatterns['4/4'];
                    const measureLength = beatsPerMeasure; // in beat units
                    const beatPosition = (event.start % measureLength);
                    const beatIndex = Math.floor(beatPosition) % pattern.length;
                    velocity *= pattern[beatIndex];

                    // ====== 4. PHRASE CONTOUR ======
                    // Rising lines crescendo, falling lines diminuendo
                    if (!voicePitchHistory[trackIdx]) {
                        voicePitchHistory[trackIdx] = [];
                    }
                    const history = voicePitchHistory[trackIdx];
                    if (history.length > 0) {
                        const prevPitch = history[history.length - 1];
                        const interval = event.pitch - prevPitch;

                        if (interval > 0) {
                            // Rising: crescendo effect, scaled by interval size
                            velocity *= 1.0 + Math.min(interval * 0.012, 0.15);
                        } else if (interval < 0) {
                            // Falling: gentle diminuendo
                            velocity *= 1.0 + Math.max(interval * 0.008, -0.10);
                        }

                        // Leap emphasis: large intervals get slight accent
                        if (Math.abs(interval) > 5) {
                            velocity *= 1.05;
                        }
                    }
                    history.push(event.pitch);
                    if (history.length > 8) history.shift(); // Keep recent context

                    // ====== 5. REGISTER COLORING ======
                    // High notes naturally "speak" more; deep bass is felt
                    const registerCenter = 60; // Middle C
                    const registerOffset = (event.pitch - registerCenter) / 24; // 2 octaves = full range
                    velocity *= 0.95 + registerOffset * 0.12;

                    // ====== 6. DENSITY RESPONSE ======
                    // Sparse passages: intimate; Dense passages: full
                    const windowKey = Math.floor(event.scaledStart / windowSize);
                    const localDensity = densityMap.get(windowKey) || 1;
                    const densityRatio = localDensity / maxDensity;
                    if (densityRatio < 0.3) {
                        velocity *= 0.90; // Sparse: more intimate
                    } else if (densityRatio > 0.7) {
                        velocity *= 1.06; // Dense: fuller sound
                    }

                    // ====== 7. HUMANIZATION ======
                    // Subtle random variation - music breathes
                    velocity += (Math.random() - 0.5) * 6;

                    // Micro-timing: slight push/pull (Â±15ms)
                    const timingOffset = (Math.random() - 0.5) * 0.015;

                    // ====== 8. DURATION SHAPING ======
                    // Melody notes sustain fully; inner voices slightly detached
                    let durationMult = 1.0;
                    if (trackIdx === 1) durationMult = 0.92;
                    if (trackIdx === 2) durationMult = 0.88;

                    // ====== FINAL VELOCITY ======
                    velocity = Math.max(25, Math.min(115, Math.round(velocity)));

                    notes.push({
                        pitch: event.pitch,
                        startTime: Math.max(0, event.scaledStart + timingOffset),
                        endTime: event.scaledStart + timingOffset + (event.scaledDuration * durationMult),
                        velocity: velocity,
                        program: 0 // Piano
                    });
                });

                // Sort by start time for proper playback
                notes.sort((a, b) => a.startTime - b.startTime);

                return {
                    notes: notes,
                    totalTime: totalTime
                };
            } catch (error) {
                console.error("Error extracting notes:", error);
                return null;
            }
        }

        // Create cursor for notation
        function createCursor() {
            const svg = document.querySelector("#notation svg");
            if (!svg) return;

            const existingCursor = svg.querySelector(".abcjs-cursor");
            if (existingCursor) existingCursor.remove();

            const cursor = document.createElementNS("http://www.w3.org/2000/svg", "line");
            cursor.setAttribute("class", "abcjs-cursor");
            cursor.setAttributeNS(null, 'x1', 0);
            cursor.setAttributeNS(null, 'y1', 0);
            cursor.setAttributeNS(null, 'x2', 0);
            cursor.setAttributeNS(null, 'y2', 0);
            cursor.setAttribute("stroke", "#8b4513");
            cursor.setAttribute("stroke-width", "3");
            cursor.setAttribute("opacity", "0.8");
            svg.appendChild(cursor);
        }

        // Update cursor position based on playback time
        function updateCursor(currentTime) {
            if (!timingEvents || timingEvents.length === 0) return;

            // Find the current event based on time
            let currentEvent = null;
            for (let i = timingEvents.length - 1; i >= 0; i--) {
                if (timingEvents[i].startTime <= currentTime) {
                    currentEvent = timingEvents[i];
                    break;
                }
            }

            const cursor = document.querySelector("#notation svg .abcjs-cursor");
            if (cursor && currentEvent && currentEvent.left !== undefined) {
                cursor.setAttributeNS(null, 'x1', currentEvent.left - 2);
                cursor.setAttributeNS(null, 'x2', currentEvent.left - 2);
                cursor.setAttributeNS(null, 'y1', currentEvent.top || 0);
                cursor.setAttributeNS(null, 'y2', (currentEvent.top || 0) + (currentEvent.height || 50));
            }
        }

        // Clear cursor
        function clearCursor() {
            const cursor = document.querySelector("#notation svg .abcjs-cursor");
            if (cursor) {
                cursor.setAttributeNS(null, 'x1', 0);
                cursor.setAttributeNS(null, 'x2', 0);
                cursor.setAttributeNS(null, 'y1', 0);
                cursor.setAttributeNS(null, 'y2', 0);
            }
        }

        // Format time as mm:ss
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Create audio controls HTML
        function createControls() {
            return `
                <div class="magenta-controls">
                    <button id="playBtn">Play</button>
                    <button id="stopBtn">Stop</button>
                    <div class="progress-container" id="progressContainer">
                        <div class="progress-bar" id="progressBar"></div>
                    </div>
                    <span class="time-display">
                        <span id="currentTime">0:00</span> / <span id="totalTime">0:00</span>
                    </span>
                </div>
            `;
        }

        // Update progress bar during playback
        function startProgressAnimation() {
            const progressBar = document.getElementById('progressBar');
            const currentTimeEl = document.getElementById('currentTime');

            function animate() {
                if (!isPlaying) return;

                const elapsed = (Date.now() - playbackStartTime) / 1000;
                const progress = Math.min(elapsed / totalDuration, 1);

                if (progressBar) progressBar.style.width = `${progress * 100}%`;
                if (currentTimeEl) currentTimeEl.textContent = formatTime(elapsed);

                updateCursor(elapsed);

                if (progress < 1) {
                    animationFrameId = requestAnimationFrame(animate);
                } else {
                    stopPlayback();
                }
            }

            animationFrameId = requestAnimationFrame(animate);
        }

        // Start playback
        async function startPlayback() {
            if (!currentNoteSequence || isPlaying) return;

            const playBtn = document.getElementById('playBtn');
            playBtn.textContent = 'Playing...';
            playBtn.classList.add('playing');

            isPlaying = true;
            playbackStartTime = Date.now();

            createCursor();
            startProgressAnimation();

            try {
                await player.start(currentNoteSequence);
            } catch (error) {
                console.error("Playback error:", error);
            }

            stopPlayback();
        }

        // Stop playback
        function stopPlayback() {
            isPlaying = false;

            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }

            if (player) {
                player.stop();
            }

            const playBtn = document.getElementById('playBtn');
            if (playBtn) {
                playBtn.textContent = 'Play';
                playBtn.classList.remove('playing');
            }

            const progressBar = document.getElementById('progressBar');
            if (progressBar) progressBar.style.width = '0%';

            const currentTimeEl = document.getElementById('currentTime');
            if (currentTimeEl) currentTimeEl.textContent = '0:00';

            clearCursor();
        }

        // Load and initialize a composition (notation only, audio deferred)
        function loadComposition(index) {
            // Stop any current playback
            stopPlayback();

            currentComposition = index;
            currentNoteSequence = null;

            // Update button states
            document.querySelectorAll('.composition-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i === index);
            });

            // Render notation
            visualObj = ABCJS.renderAbc("notation", compositions[index].abc, {
                responsive: "resize",
                add_classes: true,
                staffwidth: 900,
                wrap: {
                    minSpacing: 1.5,
                    maxSpacing: 2.7,
                    preferredMeasuresPerLine: 4
                },
                paddingtop: 10,
                paddingbottom: 10,
                paddingright: 10,
                paddingleft: 10
            })[0];

            // Extract timing events for cursor sync (doesn't need AudioContext)
            try {
                const timing = visualObj.setTiming();
                timingEvents = [];
                if (timing && timing.lines) {
                    timing.lines.forEach(line => {
                        if (!line.staff) return;
                        line.staff.forEach(staff => {
                            if (!staff.voices) return;
                            staff.voices.forEach(voice => {
                                voice.forEach(element => {
                                    if (element.startTime !== undefined && element.abselem) {
                                        const abselem = element.abselem;
                                        timingEvents.push({
                                            startTime: element.startTime,
                                            left: abselem.x,
                                            top: abselem.top,
                                            height: abselem.bottom - abselem.top
                                        });
                                    }
                                });
                            });
                        });
                    });
                    timingEvents.sort((a, b) => a.startTime - b.startTime);
                }
            } catch (e) {
                console.warn("Could not extract timing events:", e);
            }

            // Show controls - audio loads on first play
            document.getElementById('audio-controls').innerHTML = createControls();

            document.getElementById('playBtn').addEventListener('click', async () => {
                await handlePlay();
            });

            document.getElementById('stopBtn').addEventListener('click', () => {
                stopPlayback();
            });

            document.getElementById('progressContainer').addEventListener('click', () => {
                stopPlayback();
            });
        }

        // Handle play button - loads audio on first click
        async function handlePlay() {
            if (isPlaying) {
                stopPlayback();
                return;
            }

            const playBtn = document.getElementById('playBtn');

            // Load audio if not yet loaded
            if (!currentNoteSequence) {
                playBtn.textContent = 'Loading...';
                playBtn.disabled = true;

                try {
                    currentNoteSequence = await createNoteSequenceFromAbcjs(visualObj);

                    if (!currentNoteSequence) {
                        playBtn.textContent = 'Error';
                        return;
                    }

                    totalDuration = currentNoteSequence.totalTime;
                    document.getElementById('totalTime').textContent = formatTime(totalDuration);

                    if (!player) {
                        player = new mm.SoundFontPlayer(SOUNDFONT_URL);
                    }

                    await player.loadSamples(currentNoteSequence);
                } catch (error) {
                    console.error("Failed to load audio:", error);
                    playBtn.textContent = 'Error';
                    return;
                }

                playBtn.disabled = false;
            }

            startPlayback();
        }

        // Initialize on page load
        window.addEventListener('load', () => {
            loadComposition(0);
        });

        // Handle window resize
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                // Re-render notation without reloading audio
                if (visualObj) {
                    visualObj = ABCJS.renderAbc("notation", compositions[currentComposition].abc, {
                        responsive: "resize",
                        add_classes: true,
                        staffwidth: 900,
                        wrap: {
                            minSpacing: 1.5,
                            maxSpacing: 2.7,
                            preferredMeasuresPerLine: 4
                        },
                        paddingtop: 10,
                        paddingbottom: 10,
                        paddingright: 10,
                        paddingleft: 10
                    })[0];
                }
            }, 250);
        });
    </script>
</body>
</html>